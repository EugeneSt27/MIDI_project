# MIDI Analysis and Knowledge Graph Project

Этот проект предназначен для анализа MIDI-файлов с целью извлечения музыкальных признаков, сравнения сегментов и построения графа знаний для потенциальной генерации музыки. Проект разработан как исследовательская задача для статьи, фокусируясь на инвариантности к транспозиции и многомерном сходстве.

## Основные возможности

- **Разметка MIDI**: Автоматическое деление на бары, фразы, гармонию и ключ.
- **Извлечение признаков**: Pitch (относительно аккорда), harmony, rhythm, structure.
- **Сравнение сегментов**: Многомерное косинусное сходство с весами для выявления inheritance.
- **Граф знаний**: Directed graph с inheritance-ребрами, анализ и визуализация.
- **Визуализация**: Статичные (PNG) и интерактивные (HTML) графики.

## Установка

1. Клонируйте репозиторий.
2. Установите зависимости:
   ```
   pip install -r requirements.txt
   ```
3. Поместите MIDI-файлы в `data/raw/`.

## Запуск

Запустите основной скрипт:
```
python main.py
```

Скрипт обработает все MIDI в `data/raw/`, создаст аннотированные файлы в `data/annotated/`, извлечет признаки, построит графы и сохранит результаты в `results/`:
- `results/data/`: Pickle-файлы с данными (phrases, features).
- `results/graphs/`: PNG-графики (matplotlib).
- `results/better_graphs/`: HTML-графики (plotly, интерактивные).

## Структура проекта

```
MIDI_project/
├── main.py                 # Основной скрипт (разметка, анализ, визуализация)
├── test.py                 # Тестовый скрипт
├── requirements.txt        # Зависимости
├── README.md               # Этот файл
├── data/
│   ├── raw/                # Исходные MIDI-файлы
│   └── annotated/          # Аннотированные MIDI
├── results/
│   ├── data/               # Данные (pickle)
│   ├── graphs/             # Графики PNG
│   └── better_graphs/      # Красивые графики HTML
└── src/
    ├── config.py           # Параметры (пороги, веса)
    ├── midi/
    │   ├── extract.py      # Извлечение нот, метаданных
    │   ├── annotate.py     # Аннотация MIDI
    │   └── io.py           # Загрузка/сохранение
    ├── analysis/
    │   ├── structure.py    # Биты, бары, фразы
    │   ├── harmony.py      # Аккорды
    │   ├── features.py     # Векторы признаков
    │   ├── development.py  # Сходство и inheritance
    │   └── rhythm.py       # Ритмические метрики (устаревший)
    └── knowledge/
        └── graph.py        # Построение и визуализация графа
```

## Методология

1. **Разметка**: MIDI делится на биты, бары (по time signature), фразы (группы баров).
2. **Признаки**: Для каждой фразы вычисляется вектор (39 элементов): pitch (относительный), harmony, rhythm, structure.
3. **Сравнение**: Косинусное сходство с весами (pitch=1, chord=1.5, rhythm=2, struct=1) для inheritance.
4. **Граф**: Узлы — фразы, ребра — inheritance с весами. Анализ: корневые/листовые узлы, влиятельные.

## Параметры

Настраивайте в `src/config.py`:
- `SIMILARITY_THRESHOLD`: Порог сходства (0.75).
- `MAX_PARENTS`: Макс. родителей (3).
- `WEIGHTS`: Весы для компонентов.
- `BARS_PER_PHRASE`: Бар в фразе (4).
